// Package acceptance_test contains acceptance tests generated from GWT specs.
// This file provides shared helpers used across generated test files.
// It is NOT generated by the acceptance pipeline and will not be overwritten.
package acceptance_test

import (
	"bytes"
	"os"
	"os/exec"
	"path/filepath"
	"testing"
)

// runResult holds the separated output of a pmk command execution.
type runResult struct {
	Stdout string
	Stderr string
	OK     bool // true if exit code 0
}

// runParse invokes "pmk parse --project <projectPath> <binderPath>" via `go run .`
// executed from the project root (one directory above this test package).
func runParse(t *testing.T, binderPath, projectPath string) runResult {
	t.Helper()
	cmd := exec.Command("go", "run", ".", "parse", "--project", projectPath, binderPath)
	cmd.Dir = ".."
	var stdout, stderr bytes.Buffer
	cmd.Stdout = &stdout
	cmd.Stderr = &stderr
	err := cmd.Run()
	return runResult{
		Stdout: stdout.String(),
		Stderr: stderr.String(),
		OK:     err == nil,
	}
}

// writeFile writes content to dir/name, creating parent directories as needed,
// and returns the absolute path.
func writeFile(t *testing.T, dir, name, content string) string {
	t.Helper()
	path := filepath.Join(dir, name)
	if err := os.MkdirAll(filepath.Dir(path), 0o755); err != nil {
		t.Fatalf("mkdir %s: %v", filepath.Dir(path), err)
	}
	if err := os.WriteFile(path, []byte(content), 0o644); err != nil {
		t.Fatalf("writeFile %s: %v", name, err)
	}
	return path
}

// writeProjectJSON creates a project.json in dir with the given relative file paths.
func writeProjectJSON(t *testing.T, dir string, files ...string) string {
	t.Helper()
	list := ""
	for i, f := range files {
		if i > 0 {
			list += ","
		}
		list += `"` + f + `"`
	}
	return writeFile(t, dir, "project.json", `{"version":"1","files":[`+list+`]}`)
}
