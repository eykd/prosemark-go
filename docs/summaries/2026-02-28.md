# Project State Summary — 2026-02-28

## Executive Summary

`prosemark-go` is a Go CLI tool (`pmk`) for managing long-form prose projects using a binder-based outline strategy. As of this date, the first major feature — **001-prosemark-binder** — has been fully implemented and merged to `master`. The codebase passes all quality gates with 97.1% overall test coverage (100% of non-Impl functions covered), and the CLI is functionally complete for all four core operations: parse, add, delete, and move.

---

## Project Identity

- **Module**: `github.com/eykd/prosemark-go`
- **Binary**: `pmk`
- **Go Version**: 1.25.6
- **Dependencies**: `github.com/spf13/cobra v1.10.2`, `github.com/spf13/pflag v1.0.9`
- **Current Branch**: `master`
- **Active Feature**: `001-prosemark-binder` (merged via PR #1)

---

## Architecture Overview

```
prosemark-go/
├── main.go                          # Entry point; version injection
├── cmd/                             # Cobra subcommands (CLI layer)
│   ├── root.go                      # Root command; resolveBinderPath helper
│   ├── parse.go                     # pmk parse  → JSON to stdout
│   ├── addchild.go                  # pmk add    → confirmation to stdout
│   ├── delete.go                    # pmk delete → confirmation to stdout
│   ├── move.go                      # pmk move   → confirmation to stdout
│   └── scan.go                      # Filesystem scanning helpers
├── internal/binder/                 # Domain layer
│   ├── types.go                     # Node, Diagnostic, ParseResult, OpResult, etc.
│   ├── parser.go                    # Two-pass binder parser (wikilinks, refs, fences)
│   ├── selector.go                  # Selector evaluation (path:segment[N] syntax)
│   ├── serializer.go                # Lossless round-trip serialization
│   └── ops/                         # Mutation operations
│       ├── addchild.go              # Insert child node at position
│       ├── delete.go                # Remove node and subtree
│       └── move.go                  # Relocate node with re-indentation
├── acceptance/                      # ATDD pipeline infrastructure
│   ├── types.go                     # Step, Scenario, Feature types
│   ├── parser.go                    # GWT spec parser
│   ├── generator.go                 # Test code generator (preserves bound tests)
│   ├── ir.go                        # Intermediate representation (JSON)
│   └── cmd/pipeline/main.go         # Pipeline CLI (parse|generate|run)
├── conformance/                     # Binary conformance test runner
│   └── runner_test.go
├── generated-acceptance-tests/      # Auto-generated from specs (committed)
├── acceptance-pipeline/ir/          # Parsed IR JSON (committed)
├── specs/001-prosemark-binder/      # GWT acceptance specs and design docs
│   ├── spec.md                      # Feature spec (17 KB)
│   ├── plan.md                      # Implementation plan (19 KB)
│   ├── data-model.md                # Domain model (10 KB)
│   ├── US1-parse-binder-file.txt    # 9 GWT scenarios
│   ├── US2-add-child-node.txt       # 9 GWT scenarios
│   ├── US3-delete-node.txt          # 9 GWT scenarios
│   ├── US4-move-node.txt            # 7 GWT scenarios
│   └── US5-conformance-test-suite.txt  # 6 GWT scenarios
└── docs/
    ├── prosemark_binder_format_spec_v1.md    # Normative format spec
    └── prosemark_binder_operations_spec_v1.md # Normative operations spec
```

---

## CLI Interface

All subcommands accept `--project <dir>` to specify the project directory; defaults to `$CWD`. The binder file is always `_binder.md` within that directory.

| Command | Flags | Output |
|---------|-------|--------|
| `pmk parse` | `--project <dir>` | JSON to stdout |
| `pmk add` | `--project`, `--parent`, `--target`, `--title`, `--first/--at/--before/--after`, `--force` | Confirmation to stdout; diagnostics to stderr |
| `pmk delete` | `--project`, `--selector`, `--yes` | Confirmation to stdout; diagnostics to stderr |
| `pmk move` | `--project`, `--source`, `--dest`, `--yes`, `--first/--at/--before/--after` | Confirmation to stdout; diagnostics to stderr |

**Output convention**: Human-readable confirmations go to stdout; diagnostic messages (errors, warnings with codes) go to stderr. Exit 1 on any error.

**Note**: The `--json` flag exists on all commands. On `parse` it is a no-op (always JSON). On mutation commands, `--json` suppresses human messages and emits an `OpResult` JSON object to stdout — used by the conformance test runner.

---

## Domain Model

### Core Types

**`Node`** — A structural element in the binder tree:
- `Type`: `"root"` | `"node"`
- `Target`: resolved `.md` filepath
- `Title`: optional display title
- `Children`: ordered child nodes
- `SourceLine`: line number in `_binder.md`
- `LinkStyle`: `"inline"` | `"wikilink"` | `"footnote"`

**`Diagnostic`** — Structured error/warning:
- Code scheme: `BNDE*` (parse errors), `BNDW*` (parse warnings), `OPE*` (op errors), `OPW*` (op warnings)
- Fields: `Severity`, `Code`, `Message`, `Location` (line/col/byte)

**`ParseResult`** — Full parse output:
- `Root`: the binder tree
- `Diagnostics`: all errors/warnings
- `Pragmas`: detected pragma lines
- `RefDefs`: footnote-style reference definitions

**`OpResult`** — Mutation command JSON output (for `--json` mode):
- `OK`: success flag
- `Modified`: whether file was changed
- `Diagnostics`: operation diagnostics

### Selector Syntax

Selectors navigate the tree: `segment:segment[N]`
- Bare stem: `chapter` matches `chapter.md`
- Index qualifier: `chapter[1]` picks the second match
- Chain: `part1:chapter` navigates child of `part1`
- Root: `.` refers to the binder root

---

## Feature 001-prosemark-Binder: Implementation Status

### User Stories Completed

| Story | Description | Acceptance Scenarios |
|-------|-------------|---------------------|
| US1 | Parse Binder File | 9 scenarios: inline/wiki/footnote links, error codes, code blocks, CRLF |
| US2 | Add Child Node | 9 scenarios: positioning flags, idempotency, ordered lists, tab indent |
| US3 | Delete Node | 9 scenarios: leaf/subtree, blank line collapse, footnote preservation |
| US4 | Move Node | 7 scenarios: reorder, subtree, cycle detection, re-indentation |
| US5 | Conformance Test Suite | 6 scenarios: all 135 conformance fixtures pass |

### Conformance Test Suite

The project includes a binary-level conformance runner in `conformance/runner_test.go` that:
1. Builds the `pmk` binary
2. Reads fixture files from `docs/conformance/v1/`
3. Runs each fixture against the binary via `pmk <op> --json`
4. Compares actual vs expected output/diagnostics

### Notable Implementation Details

**Parser** (`internal/binder/parser.go`):
- Two-pass: pass1 collects ref defs and pragmas; pass2 extracts structure
- Supports inline links `[text](url)`, wikilinks `[[file]]`, footnote links `[text][ref]`
- UTF-8 BOM stripping; CRLF preservation
- Fence detection prevents links inside code blocks from being treated as structural

**AddChild** (`internal/binder/ops/addchild.go`):
- Deep-tree parent search (not just top-level)
- Idempotency: OPW002 warning when target already present (unless `--force`)
- Position resolution: `--first`, `--at N`, `--before <sibling>`, `--after <sibling>`
- Marker inference: inherits unordered marker style or continues ordered list numbering
- Indent inference: inherits existing indentation or defaults

**Delete** (`internal/binder/ops/delete.go`):
- Subtree deletion with OPW005 cascade warning
- Empty sublist pruning (OPW004) and consecutive blank line collapse
- Non-structural content warning (OPW003)
- Footnote ref def preservation

**Move** (`internal/binder/ops/move.go`):
- Cycle detection prevents moving to own descendant (OPE003)
- Re-indentation of all lines to destination level
- Checkbox stripping on first line
- Post-removal insertion index adjustment (accounts for removed lines)

**Serializer** (`internal/binder/serializer.go`):
- Byte-identical round-trip for valid input (lossless)
- Preserves UTF-8 BOM and line endings

---

## Recent Commit History (Last 10)

| Hash | Message |
|------|---------|
| `5983d8d` | fix: 4 integration bugs found during end-to-end testing |
| `729b2e4` | feat(cmd): rename add-child subcommand to add |
| `c488099` | feat(cmd): replace positional binder-path arg with --project flag |
| `0cb3c32` | Merge pull request #1 from eykd/001-prosemark-binder |
| `58d166a` | fix(cmd): restore --json flag to all commands; fix lefthook silent failure |
| `bea67f0` | fix(ops): strip wikilink brackets from target; guard read-only binder writes |
| `8275ff3` | fix(bugs): fix UTF-8 error swallow, bracket-title round-trip, and human-friendly output |
| `e6b14ea` | fix(binder): store decoded (raw-space) targets in add-child output |
| `2d4e07e` | fix(binder): percent-encode spaces in targets and reject colons |
| `a66ea8c` | fix(binder): strip .md suffix from wikilink stems before resolution |

The most recent commits (post-merge) fixed four integration bugs surfaced during end-to-end testing:
1. Show help (exit 0) when `pmk` invoked with no arguments
2. Parse trailing text after wikilink as title: `[[file.md]] Title`
3. Warn (OPW005) when deleting a node with children (cascade delete)
4. Error (OPE010) when conflicting position flags given to `add`

---

## Test Infrastructure

### Test Streams

| Stream | Purpose | Command | Status |
|--------|---------|---------|--------|
| Unit tests | Internal correctness | `just test` | **PASS** |
| Coverage check | 100% non-Impl coverage | `just test-cover-check` | **PASS** (97.1% overall) |
| Conformance tests | Binary-level behavior | `just conformance-run` | PASS (cached) |
| Acceptance tests | Observable behavior | `just acceptance` | Generated; bound stubs present |

### Coverage by Package

| Package | Coverage | Non-Impl 100%? |
|---------|----------|----------------|
| `internal/binder` | 100.0% | Yes |
| `internal/binder/ops` | 100.0% | Yes |
| `acceptance` | 92.0% | Yes (Impl functions exempt) |
| `cmd` | 91.8% | Yes (Impl functions exempt) |
| `conformance` | (no statements) | N/A |
| **Overall** | **97.1%** | **Yes** |

### Impl Pattern

Functions wrapping OS/exec calls are named with `*Impl` suffix and excluded from coverage:
- `WriteBinderAtomicImpl` — atomic temp-file-then-rename write
- `ParseSpecFileImpl` — disk read for acceptance spec parsing
- `WriteTestFileImpl`, `WriteIRImpl`, `ReadIRImpl` — acceptance pipeline I/O
- `ScanProjectImpl` — filesystem scan for project files

### Test File Count

- `cmd/`: 9 test files (unit + IO injection tests)
- `internal/binder/`: 5 test files
- `internal/binder/ops/`: 5 test files (including coverage gaps and move edge cases)
- `acceptance/`: 4 test files (pipeline infrastructure)
- `conformance/`: 1 test file (binary runner)
- `generated-acceptance-tests/`: 6 test files (generated stubs + helpers)

---

## Quality Gates

All enforced via `lefthook` pre-commit hooks and `just check`:

| Gate | Tool | Status |
|------|------|--------|
| Formatting | `gofmt` | Pass |
| Static analysis | `go vet` | Pass |
| Linting | `staticcheck` | Pass |
| Coverage | 100% non-Impl | Pass |
| CLI smoke test | `just smoke` | Pass |

---

## Beads Issue Tracker

**Project Stats**: 41 total issues — 35 closed, 6 open, 0 in-progress

### Open Issues

| ID | Type | Priority | Title | Status |
|----|------|----------|-------|--------|
| `prosemark-go-48x` | epic | P0 | Feature: prosemark-binder | Open (all 9 phase tasks complete; blocks 3 issues) |
| `prosemark-go-ef7` | bug | P1 | Fix silent discard of binder.Parse error in cmd/parse.go | Blocked by epic |
| `prosemark-go-6pb` | task | P3 | Remove duplicate addChildOutput/deleteOutput structs in cmd | Blocked by epic |
| `prosemark-go-zfg` | task | P3 | Eliminate `_` error discard in cmd/addchild.go and cmd/delete.go | Blocked by epic |
| `prosemark-go-oei` | task | P3 | Validate --project flag as required in all subcommands | Ready |
| `prosemark-go-f1o` | task | P4 | Add input size limit for binder file reads | Ready |

The epic (`prosemark-go-48x`) is technically still open but all 9 implementation phase sub-tasks are complete. Closing it would unblock the three dependent issues.

---

## ATDD Pipeline

The project uses a two-stage acceptance test pipeline:

```
specs/001-prosemark-binder/*.txt
    │ (just acceptance-parse)
    ▼
acceptance-pipeline/ir/*.json        ← committed intermediate representation
    │ (just acceptance-generate)
    ▼
generated-acceptance-tests/*_test.go ← committed generated test stubs
    │ (just acceptance-run)
    ▼
Test results (Go test output)
```

**Stub preservation**: The generator (`acceptance/generator.go`) detects bound (implemented) test functions and preserves their bodies across regeneration — only unbound stubs (containing `t.Skip("acceptance test not yet bound")`) are overwritten.

---

## Normative Specifications

Two normative specification documents live in `docs/`:

**`prosemark_binder_format_spec_v1.md`** — defines:
- File identification: `_binder.md` in project root, UTF-8
- Pragma: `<!-- prosemark-binder:v1 -->`
- Structural nodes: CommonMark list items with ≥1 valid structural link to a `.md` file
- Link formats: inline, wikilink (Obsidian-style), footnote-style
- Round-trip fidelity requirement (lossless)

**`prosemark_binder_operations_spec_v1.md`** — defines:
- Error/warning code schema (`BNDE*`, `BNDW*`, `OPE*`, `OPW*`)
- Operation preconditions and postconditions
- Conformance fixture format and runner contract

---

## Development Workflow

### Standard TDD Cycle
1. Write failing test (Red)
2. Minimal implementation to pass (Green)
3. Refactor while keeping green

### Quality Check Sequence
```bash
just check           # fmt + vet + lint + test-cover-check
just smoke           # CLI smoke test (required after cmd changes)
just test-all        # unit + acceptance + conformance
```

### Commit Convention
Conventional commits (`feat`, `fix`, `refactor`, `test`, `chore`) with scope.
All commits co-authored with `Claude Sonnet 4.6`.

---

## Known Issues and Next Steps

1. **Close the epic** (`prosemark-go-48x`): All 9 phase tasks are complete. Closing unblocks `ef7`, `6pb`, `zfg`.
2. **P1 bug** (`prosemark-go-ef7`): Silent discard of `binder.Parse` error in `cmd/parse.go` — error returned but not checked on the OPE009 diagnostic path.
3. **P3 cleanup** (`prosemark-go-zfg`): `_` error discards in `cmd/addchild.go` and `cmd/delete.go` need explicit handling.
4. **P3 refactor** (`prosemark-go-6pb`): Duplicate `addChildOutput`/`deleteOutput` structs in `cmd/` package can be consolidated.
5. **P3 validation** (`prosemark-go-oei`): `--project` flag should be validated as required rather than silently defaulting; explicit is better.
6. **P4 hardening** (`prosemark-go-f1o`): Input size limit for binder file reads to prevent memory exhaustion on malformed inputs.
